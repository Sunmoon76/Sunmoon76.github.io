<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/wind32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/wind16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-atom.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunmoon.com","root":"/","scheme":"Gemini","version":"8.0.0-rc.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Zookeeper介绍ZooKeeper是一个分布式服务协调框架，主要用来解决分布式应用中的一些数据管理问题，如：统一命名服务、状态同步服务、应用配置项的管理等等。 ZooKeeper由雅虎研究院开发，是Google Chubby的开源实现，后来托管到Apache，于2010年11月正式成为Apache的顶级项目。 在大数据生态系统里，很多组件的命名都是某种动物，比如hadoop就是🐘，hive">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper">
<meta property="og:url" content="http://sunmoon.com/2020/10/14/Zookeeper/index.html">
<meta property="og:site_name" content="清风的博客">
<meta property="og:description" content="Zookeeper介绍ZooKeeper是一个分布式服务协调框架，主要用来解决分布式应用中的一些数据管理问题，如：统一命名服务、状态同步服务、应用配置项的管理等等。 ZooKeeper由雅虎研究院开发，是Google Chubby的开源实现，后来托管到Apache，于2010年11月正式成为Apache的顶级项目。 在大数据生态系统里，很多组件的命名都是某种动物，比如hadoop就是🐘，hive">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011162905155.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011165117802.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011165353665.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011165933305.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011170501940.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011170920874.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011171243332.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201011172541673.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014104442293.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014113353020.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014113209852.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014144022534.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014144945595.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201014145925480.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201012173352810.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201012185750043.png">
<meta property="og:image" content="http://sunmoon.com/assets/image-20201012183855327.png">
<meta property="article:published_time" content="2020-10-14T08:41:33.000Z">
<meta property="article:modified_time" content="2020-10-14T08:46:37.540Z">
<meta property="article:author" content="Sunmoon">
<meta property="article:tag" content="分布式协调框架">
<meta property="article:tag" content="zookeeper数据结构">
<meta property="article:tag" content="zookeeper常见命令">
<meta property="article:tag" content="zookeeper使用场景">
<meta property="article:tag" content="zookeeper集群">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://sunmoon.com/assets/image-20201011162905155.png">

<link rel="canonical" href="http://sunmoon.com/2020/10/14/Zookeeper/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Zookeeper | 清风的博客</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before, .use-motion .logo-line-after {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
  <div id="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<link rel="alternate" href="/atom.xml" title="清风的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <main class="main">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line toggle-line-first"></span>
        <span class="toggle-line toggle-line-middle"></span>
        <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line-before"></i>
      <h1 class="site-title">清风的博客</h1>
      <i class="logo-line-after"></i>
    </a>
      <p class="site-subtitle" itemprop="description">山水有相逢，山不动，水不停</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper介绍"><span class="nav-number">1.</span> <span class="nav-text">Zookeeper介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper安装"><span class="nav-number">2.</span> <span class="nav-text">Zookeeper安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务端"><span class="nav-number">2.1.</span> <span class="nav-text">服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置"><span class="nav-number">2.1.2.</span> <span class="nav-text">修改配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.1.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令行客户端"><span class="nav-number">2.2.</span> <span class="nav-text">命令行客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI界面客户端"><span class="nav-number">2.3.</span> <span class="nav-text">UI界面客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接服务"><span class="nav-number">2.3.3.</span> <span class="nav-text">连接服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper数据结构"><span class="nav-number">3.</span> <span class="nav-text">Zookeeper数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构"><span class="nav-number">3.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节点类型"><span class="nav-number">3.2.</span> <span class="nav-text">节点类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper常见命令"><span class="nav-number">4.</span> <span class="nav-text">Zookeeper常见命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建节点"><span class="nav-number">4.1.</span> <span class="nav-text">创建节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看节点"><span class="nav-number">4.2.</span> <span class="nav-text">查看节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看节点信息"><span class="nav-number">4.2.1.</span> <span class="nav-text">查看节点信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看节点列表"><span class="nav-number">4.2.2.</span> <span class="nav-text">查看节点列表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改节点"><span class="nav-number">4.3.</span> <span class="nav-text">修改节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#删除节点"><span class="nav-number">4.4.</span> <span class="nav-text">删除节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监听节点"><span class="nav-number">4.5.</span> <span class="nav-text">监听节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Java操作Zookeeper"><span class="nav-number">5.</span> <span class="nav-text">Java操作Zookeeper</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境导入"><span class="nav-number">5.1.</span> <span class="nav-text">环境导入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接ZK"><span class="nav-number">5.2.</span> <span class="nav-text">连接ZK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节点操作"><span class="nav-number">5.3.</span> <span class="nav-text">节点操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#节点监听"><span class="nav-number">5.4.</span> <span class="nav-text">节点监听</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper使用场景"><span class="nav-number">6.</span> <span class="nav-text">Zookeeper使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ID生成器"><span class="nav-number">6.1.</span> <span class="nav-text">ID生成器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置中心"><span class="nav-number">6.2.</span> <span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式协调"><span class="nav-number">6.3.</span> <span class="nav-text">分布式协调</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群选主"><span class="nav-number">6.4.</span> <span class="nav-text">集群选主</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式锁"><span class="nav-number">6.5.</span> <span class="nav-text">分布式锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#集群-高级"><span class="nav-number">7.</span> <span class="nav-text">集群(高级)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#集群介绍"><span class="nav-number">7.1.</span> <span class="nav-text">集群介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群搭建"><span class="nav-number">7.2.</span> <span class="nav-text">集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#软件准备"><span class="nav-number">7.2.1.</span> <span class="nav-text">软件准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置-1"><span class="nav-number">7.2.2.</span> <span class="nav-text">修改配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建节点ID"><span class="nav-number">7.2.3.</span> <span class="nav-text">创建节点ID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动集群"><span class="nav-number">7.2.4.</span> <span class="nav-text">启动集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接测试"><span class="nav-number">7.2.5.</span> <span class="nav-text">连接测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一致性事务处理"><span class="nav-number">7.3.</span> <span class="nav-text">一致性事务处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群角色"><span class="nav-number">7.3.1.</span> <span class="nav-text">集群角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper的特性"><span class="nav-number">7.3.2.</span> <span class="nav-text">Zookeeper的特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZAB协议"><span class="nav-number">7.3.3.</span> <span class="nav-text">ZAB协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务请求的处理流程"><span class="nav-number">7.3.4.</span> <span class="nav-text">事务请求的处理流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群选举"><span class="nav-number">7.4.</span> <span class="nav-text">集群选举</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器状态"><span class="nav-number">7.4.1.</span> <span class="nav-text">服务器状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器启动时期的leader选举"><span class="nav-number">7.4.2.</span> <span class="nav-text">服务器启动时期的leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器运行时期的Leader选举"><span class="nav-number">7.4.3.</span> <span class="nav-text">服务器运行时期的Leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#observer角色及其配置"><span class="nav-number">7.4.4.</span> <span class="nav-text">observer角色及其配置</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sunmoon"
      src="/images/sunmoon.jpg">
  <p class="site-author-name" itemprop="name">Sunmoon</p>
  <div class="site-description" itemprop="description">阴晴雨雪，月圆月缺</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">190</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sunmoon76" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sunmoon76" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/gongleman9016/" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;gongleman9016&#x2F;" rel="noopener" target="_blank"><i class="fa fa-cube fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </header>

      
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/Sunmoon76" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


      <div class="main-inner">
        

        <div class="content post posts-expand">
          

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://sunmoon.com/2020/10/14/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sunmoon.jpg">
      <meta itemprop="name" content="Sunmoon">
      <meta itemprop="description" content="阴晴雨雪，月圆月缺">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="清风的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zookeeper
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-10-14 16:41:33 / 修改时间：16:46:37" itemprop="dateCreated datePublished" datetime="2020-10-14T16:41:33+08:00">2020-10-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>18 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Zookeeper介绍"><a href="#Zookeeper介绍" class="headerlink" title="Zookeeper介绍"></a>Zookeeper介绍</h1><p>ZooKeeper是一个分布式服务<strong>协调</strong>框架，主要用来解决分布式应用中的一些数据管理问题，如：统一命名服务、状态同步服务、应用配置项的管理等等。</p>
<p>ZooKeeper由雅虎研究院开发，是Google Chubby的开源实现，后来托管到Apache，于2010年11月正式成为Apache的顶级项目。</p>
<p>在大数据生态系统里，很多组件的命名都是某种动物，比如hadoop就是🐘，hive就是🐝。Zookeeper的作用是用来对这些组件进行管理，即动物园管理者。</p>
<p>官方网址：<a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">https://zookeeper.apache.org/</a></p>
<a id="more"></a>

<h1 id="Zookeeper安装"><a href="#Zookeeper安装" class="headerlink" title="Zookeeper安装"></a>Zookeeper安装</h1><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>将资料中的zookeeper-3.4.6.zip复制到一个没有中文，没有空格的目录，然后解压，即可得到zookeeper的软件</p>
<p><img data-src="/assets/image-20201011162905155.png" alt="image-20201011162905155"> </p>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><ol>
<li>进入到zookeeper的配置目录，复制<code>zoo_sample.cfg</code>为<code>zoo.cfg</code></li>
<li>编辑<code>zoo.cfg</code>文件，修改<code>dataDir</code>的值为<code>安装目录\\data</code>这是zookeeper存储数据的位置</li>
</ol>
<p><img data-src="/assets/image-20201011165117802.png" alt="image-20201011165117802"></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>进入安装路径的bin目录，双击zkServer.cmd即可启动zookeeper服务</p>
<p><img data-src="/assets/image-20201011165353665.png" alt="image-20201011165353665"> </p>
<h2 id="命令行客户端"><a href="#命令行客户端" class="headerlink" title="命令行客户端"></a>命令行客户端</h2><ol>
<li>进入安装路径的bin目录，双击zkCli.cmd即可启动zookeeper命令行客户端</li>
<li>在客户端中输入<code>create /data &quot;ceshi&quot;</code>，没有报错，代表客户端可以成功操作服务器 </li>
</ol>
<p><img data-src="/assets/image-20201011165933305.png" alt="image-20201011165933305"> </p>
<h2 id="UI界面客户端"><a href="#UI界面客户端" class="headerlink" title="UI界面客户端"></a>UI界面客户端</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>将资料中的ZooInspector.zip复制到一个没有中文，没有空格的目录，然后解压，即可得到ZooInspector的软件</p>
<p><img data-src="/assets/image-20201011170501940.png" alt="image-20201011170501940"> </p>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><p>在安装软件的build目录下，执行<code>java -jar zookeeper-dev-ZooInspector.jar</code>命令，即可启动软件的界面</p>
<p><img data-src="/assets/image-20201011170920874.png" alt="image-20201011170920874"> </p>
<h3 id="连接服务"><a href="#连接服务" class="headerlink" title="连接服务"></a>连接服务</h3><ol>
<li>点击连接按钮，输入zk的服务地址，点击OK连接</li>
<li>连接成功之后可以点击data查看节点存储的信息</li>
</ol>
<p><img data-src="/assets/image-20201011171243332.png" alt="image-20201011171243332"> </p>
<h1 id="Zookeeper数据结构"><a href="#Zookeeper数据结构" class="headerlink" title="Zookeeper数据结构"></a>Zookeeper数据结构</h1><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>Zookeeper的数据节点可以视为树状（或者目录）结构，树中的各节点被称为znode（即zookeeper node），一个znode可以有多个子节点。</p>
<p>Zookeeper节点在结构上表现为树状，使用路径path来定位某个znode，比如<code>/itcast/bj/java</code>，此处itcast、bj、java分别是根节点、2级节点、3级节点</p>
<p>znode兼具文件和目录两种特点。既像文件一样维护着数据、元信息、ACL、时间戳等数据结构，又可以像目录一样挂载子目录。</p>
<p>==znode特点: 像目录一样可以存储子节点,想文件一样可以存储数据信息==</p>
<p><img data-src="/assets/image-20201011172541673.png" alt="image-20201011172541673"> </p>
<p>一个znode大体上分为3各部分：</p>
<ol>
<li><p>data：节点的数据</p>
</li>
<li><p>children：节点的子节点</p>
</li>
<li><p>stat：节点的状态，用来描述当前节点的创建、修改记录等</p>
</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在zookeeper shell中使用get命令查看指定路径节点的data、stat信息：</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">5</span>] get  /itcast/bj</span><br><span class="line">bjdata</span><br><span class="line">cZxid = <span class="number">0</span>x17</span><br><span class="line">ctime = Sun Oct <span class="number">11</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">37</span> CST <span class="number">2020</span></span><br><span class="line">mZxid = <span class="number">0</span>x17</span><br><span class="line">mtime = Sun Oct <span class="number">11</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">37</span> CST <span class="number">2020</span></span><br><span class="line">pZxid = <span class="number">0</span>x1b </span><br><span class="line">cversion = <span class="number">1</span></span><br><span class="line">dataVersion = <span class="number">0</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">6</span></span><br><span class="line">numChildren = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cZxid：数据节点创建时的事务 ID</span></span><br><span class="line"><span class="comment"># ctime：数据节点创建时的时间</span></span><br><span class="line"><span class="comment"># mZxid：数据节点最后一次更新时的事务 ID</span></span><br><span class="line"><span class="comment"># mtime：数据节点最后一次更新时的时间</span></span><br><span class="line"><span class="comment"># pZxid：数据节点的子节点最后一次被修改时的事务 ID</span></span><br><span class="line"><span class="comment"># cversion：子节点的更改次数</span></span><br><span class="line"><span class="comment"># dataVersion：节点数据的更改次数</span></span><br><span class="line"><span class="comment"># aclVersion: 权限的更改次数</span></span><br><span class="line"><span class="comment"># ephemeralOwner: 持久节点还是临时节点</span></span><br><span class="line"><span class="comment"># dataLength：数据内容的长度</span></span><br><span class="line"><span class="comment"># numChildren：数据节点当前的子节点个数</span></span><br><span class="line"></span><br><span class="line">最多</span><br><span class="line"><span class="comment"># cZxid：数据节点创建时的事务ID</span></span><br><span class="line"><span class="comment"># dataVersion：节点数据的更改次数</span></span><br></pre></td></tr></table></figure>

<h2 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h2><p>对于Zookeeper中的节点，有两种分类方式，一种是按照节点是否持久化，一种是按照节点是否有顺序进行分类。</p>
<blockquote>
<p>按照节点是否持久化分类，可以分别为临时节点和永久节点</p>
</blockquote>
<ul>
<li><p><strong>临时节点</strong>：该节点的生命周期依赖于创建它们的会话。一旦会话(Session)结束，临时节点将被自动删除，当然可以也可以手动删除</p>
<p>  虽然每个临时的Znode都会绑定到一个客户端会话，但他们对所有的客户端还是可见的。另外，ZooKeeper的临时节点不允许拥有子节点</p>
</li>
<li><p><strong>持久化节点</strong>(默认)：该节点的生命周期不依赖于会话，并且只有在客户端显示执行删除操作的时候，他们才能被删除</p>
</li>
</ul>
<blockquote>
<p>按照节点是否有顺序进行分类，可以分别为有序节点和无序节点</p>
</blockquote>
<ul>
<li><strong>有序节点</strong>：每个节点都会为它的一级子节点维护一个顺序</li>
<li><strong>无序节点</strong>(默认)：节点不会为子节点维护顺序</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>节点类型</span><br><span class="line"><span class="code">	持久化无序节点 ：节点创建后会一直存在zookeeper服务器上，直到主动删除</span></span><br><span class="line"><span class="code">	持久化有序节点 ：在持久化无序节点的基础上,为每个节点都会为它的一级子节点维护一个顺序</span></span><br><span class="line"><span class="code">	临时无序节点 ： 临时节点的生命周期和客户端的会话保持一致，当客户端会话失效，该节点自动清理</span></span><br><span class="line"><span class="code">	临时有序节点 ： 在临时节点上多了一个顺序性特性</span></span><br></pre></td></tr></table></figure>



<h1 id="Zookeeper常见命令"><a href="#Zookeeper常见命令" class="headerlink" title="Zookeeper常见命令"></a>Zookeeper常见命令</h1><h2 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h2><blockquote>
<p> create [-s] [-e] path data  [默认情况下持久化无序节点]</p>
 <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">path：节点名称 (完整绝对路径, 不能缺少层数)</span><br><span class="line">data：节点数据</span><br><span class="line">-s：有序节点</span><br><span class="line">-e：临时节点</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1）创建 /node节点</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">14</span>] create /node node</span><br><span class="line">Created /node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2）创建 /node/data1节点(无序持久节点)</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">15</span>] create /node/<span class="keyword">data</span>1 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3）创建 /node/data2节点(无序临时节点)</span></span><br><span class="line"><span class="comment"># 注意: 一旦创建此节点的连接断开(命令行退出)，节点会自动删除</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">16</span>] create <span class="literal">-e</span> /node/<span class="keyword">data</span>2 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 创建 /node/data3节点(有序持久节点)</span></span><br><span class="line"><span class="comment"># 注意: 此类节点创建出来后会在节点名称后面自动跟随一串递增的数字</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">0</span>] create <span class="literal">-s</span> /node/<span class="keyword">data</span>3 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>30000000002</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">1</span>] create <span class="literal">-s</span> /node/<span class="keyword">data</span>3 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>30000000003</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 创建 /node/data4节点(有序临时节点)</span></span><br><span class="line"><span class="comment"># 注意: 此类节点创建出来后会在节点名称后面自动跟随一串递增的数字</span></span><br><span class="line"><span class="comment">#      一旦创建此节点的连接断开(命令行退出)，节点会自动删除</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">10</span>] create <span class="literal">-s</span> <span class="literal">-e</span> /node/<span class="keyword">data</span>4 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>40000000006</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">11</span>] create <span class="literal">-s</span> <span class="literal">-e</span> /node/<span class="keyword">data</span>4 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>40000000007</span><br></pre></td></tr></table></figure>

<h2 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h2><h3 id="查看节点信息"><a href="#查看节点信息" class="headerlink" title="查看节点信息"></a>查看节点信息</h3><blockquote>
<p>get path : 获取节点的状态信息和数据信息</p>
<p>stat  path : 获取节点的状态信息</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">3</span>] get /node/<span class="keyword">data</span>1</span><br><span class="line"><span class="keyword">data</span> <span class="comment"># 节点数据</span></span><br><span class="line">cZxid = <span class="number">0</span>x21   <span class="comment"># 数据节点创建时的事务ID</span></span><br><span class="line">ctime = Sun Oct <span class="number">11</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">27</span> CST <span class="number">2020</span>  <span class="comment"># 数据节点创建时的时间</span></span><br><span class="line">mZxid = <span class="number">0</span>x21   <span class="comment"># 数据节点最后一次更新时的事务ID</span></span><br><span class="line">mtime = Sun Oct <span class="number">11</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">27</span> CST <span class="number">2020</span>  <span class="comment"># 数据节点最后一次更新时的时间</span></span><br><span class="line">pZxid = <span class="number">0</span>x21 <span class="comment"># 数据节点的子节点最后一次被修改时的事务ID</span></span><br><span class="line">cversion = <span class="number">0</span> <span class="comment"># 子节点的更改次数</span></span><br><span class="line">dataVersion = <span class="number">0</span> <span class="comment"># 节点数据的更改次数</span></span><br><span class="line">aclVersion = <span class="number">0</span>  <span class="comment"># 权限的更改次数</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0 <span class="comment"># 如果节点为临时节点，那么它的值为这个节点拥有者的sessionID；如果该节点不是临时节点， 值为0</span></span><br><span class="line">dataLength = <span class="number">4</span> <span class="comment"># 数据内容的长度</span></span><br><span class="line">numChildren = <span class="number">0</span> <span class="comment"># 数据节点当前的子节点个数</span></span><br></pre></td></tr></table></figure>

<h3 id="查看节点列表"><a href="#查看节点列表" class="headerlink" title="查看节点列表"></a>查看节点列表</h3><blockquote>
<p>ls   path:  查看指定节点的子节点列表</p>
<p>ls2 path:  查看指定节点的信息以及子节点列表</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1) ls</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">17</span>] ls /</span><br><span class="line">[<span class="type">node</span>， <span class="type">zookeeper</span>， <span class="type">data</span>， <span class="type">itcast</span>]</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">18</span>] ls /node</span><br><span class="line">[<span class="type">data30000000003</span>， <span class="type">data30000000004</span>， <span class="type">data30000000002</span>， <span class="type">data2</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#２）ls2</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">19</span>] ls2 /</span><br><span class="line">[<span class="type">node</span>， <span class="type">zookeeper</span>， <span class="type">data</span>， <span class="type">itcast</span>]</span><br><span class="line">cZxid = <span class="number">0</span>x0</span><br><span class="line">ctime = Thu Jan <span class="number">01</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1970</span></span><br><span class="line">mZxid = <span class="number">0</span>x0</span><br><span class="line">mtime = Thu Jan <span class="number">01</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1970</span></span><br><span class="line">pZxid = <span class="number">0</span>x3c</span><br><span class="line">cversion = <span class="number">14</span></span><br><span class="line">dataVersion = <span class="number">0</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">0</span></span><br><span class="line">numChildren = <span class="number">4</span></span><br></pre></td></tr></table></figure>

<h2 id="修改节点"><a href="#修改节点" class="headerlink" title="修改节点"></a>修改节点</h2><blockquote>
<p>set path data [version]</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) set path data 直接使用set命令对指定节点内容进行修改</span></span><br><span class="line"><span class="comment"># 注意: 在修改的时候，除了数据内容变化之外，还有一个关键属性变化了  </span></span><br><span class="line"><span class="comment"># dataVersion = 1 指的是数据版本，每次数据被修改，版本自动加1</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">9</span>] set /node/<span class="keyword">data</span>1 mydata</span><br><span class="line">cZxid = <span class="number">0</span>x21</span><br><span class="line">ctime = Sun Oct <span class="number">11</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">27</span> CST <span class="number">2020</span></span><br><span class="line">mZxid = <span class="number">0</span>x40</span><br><span class="line">mtime = Sun Oct <span class="number">11</span> <span class="number">23</span>:<span class="number">26</span>:<span class="number">43</span> CST <span class="number">2020</span></span><br><span class="line">pZxid = <span class="number">0</span>x21</span><br><span class="line">cversion = <span class="number">0</span></span><br><span class="line">dataVersion = <span class="number">1</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">6</span></span><br><span class="line">numChildren = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) set path data version 基于版本号对指定节点内容进行修改</span></span><br><span class="line"><span class="comment"># 即修改数据的时候，要传入要修改数据的版本号， 如果传入的版本号和当前的版本号不符合时，zookeeper会拒绝本次修改</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">10</span>] set /node/<span class="keyword">data</span>1 mydatadata <span class="number">0</span></span><br><span class="line">version No is not valid : /node/<span class="keyword">data</span>1</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">11</span>] set /node/<span class="keyword">data</span>1 mydatadata <span class="number">1</span></span><br><span class="line">cZxid = <span class="number">0</span>x21</span><br><span class="line">ctime = Sun Oct <span class="number">11</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">27</span> CST <span class="number">2020</span></span><br><span class="line">mZxid = <span class="number">0</span>x42</span><br><span class="line">mtime = Sun Oct <span class="number">11</span> <span class="number">23</span>:<span class="number">32</span>:<span class="number">17</span> CST <span class="number">2020</span></span><br><span class="line">pZxid = <span class="number">0</span>x21</span><br><span class="line">cversion = <span class="number">0</span></span><br><span class="line">dataVersion = <span class="number">2</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">10</span></span><br><span class="line">numChildren = <span class="number">0</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">12</span>]</span><br></pre></td></tr></table></figure>

<h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><blockquote>
<p>delete path [version]    删除没有子节点的node</p>
<p>rmr path  遍历删除</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1) delete path 使用delete命令删除指定节点</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">13</span>] delete /node/<span class="keyword">data</span>30000000003</span><br><span class="line"></span><br><span class="line"><span class="comment">#2) delete path version 基于版本号删除指定节点</span></span><br><span class="line"><span class="comment">#   即删除节点的时候，要传入要删除节点的版本号， 如果传入的版本号和当前的版本号不符合时，zookeeper会拒绝本次删除</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">14</span>] delete /node/<span class="keyword">data</span>1 <span class="number">1</span></span><br><span class="line">version No is not valid : /node/<span class="keyword">data</span>1</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">14</span>] delete /node/<span class="keyword">data</span>1 <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3) rmr path 遍历删除</span></span><br><span class="line"><span class="comment"># 删除非空节点(含有子节点)失败</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">5</span>] delete /a</span><br><span class="line">Node not empty: /a</span><br><span class="line"><span class="comment"># 遍历删除</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">6</span>] rmr /a</span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">7</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">创建节点</span><br><span class="line">   create  path   data</span><br><span class="line">   			-s   顺序节点    </span><br><span class="line">   			-e   临时节点</span><br><span class="line">   get   path     节点信息和状态</span><br><span class="line">   stat  path     状态</span><br><span class="line">   </span><br><span class="line">   ls   ls2       查看子节点</span><br><span class="line">   </span><br><span class="line">   set  path  data  [version]</span><br><span class="line">   delete  path [version]</span><br><span class="line">   rmr  遍历删除</span><br><span class="line">   </span><br><span class="line">监听:   </span><br><span class="line">  ls ls2  path  watch</span><br><span class="line">  get stat   path  watch</span><br></pre></td></tr></table></figure>



<h2 id="监听节点"><a href="#监听节点" class="headerlink" title="监听节点"></a>监听节点</h2><blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;* 在zookeeper中还支持一种watch（监听）机制，它允许对zookeeper注册监听，当监听的对象发生指定的事件的时候，zookeeper就会返回一个通知。</span><br><span class="line">&gt;* 它可以监听事件类型包含下面这些:</span><br><span class="line">  None(-1):客户端和服务端连接状态发生变化</span><br><span class="line">  </span><br><span class="line">  NodeCreated(1):创建节点</span><br><span class="line">  NodeDeleted(2):删除节点</span><br><span class="line">  NodeDataChanged(3):节点数据发生变化,注意即使变更前后的数据内容完全一样也会触发该事件,或者理解成该事件的触发条件是Znode的版本号变更</span><br><span class="line">  NodeChildrenChanged(4):子节点发生变化(创建\删除\数据变更)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&gt;* 其中连接状态分为下面这些</span><br><span class="line">  Disconnected(0):断开</span><br><span class="line">  SyncConnected(3):建立连接,并且完成一次version、zxid同步</span><br><span class="line">  AuthFailed(4):授权失败</span><br><span class="line">  ConnectedReadOnly(5):只读连接</span><br><span class="line">  Expired(-112):会话超时</span><br><span class="line"></span><br><span class="line">&gt;* Zookeeper的事件监听机制有以下特性：</span><br><span class="line">1.当监听器监听的事件被触发,服务端会发送通知给客户端,但通知信息中不包括事件的具体内容。</span><br><span class="line">  以监听ZNode结点数据变化为例,当Znode的数据被改变,客户端会收到事件类型为NodeDataChanged的通知,</span><br><span class="line">  但该Znode的数据改变成了什么客户端无法从通知中获取,需要客户端在收到通知后手动去获取。</span><br><span class="line">2.Watcher是一次性的。一旦被触发将会失效。如果需要反复进行监听就需要反复进行注册。</span><br><span class="line"></span><br><span class="line">这么设计是为了减轻服务端的压力,但是对开发者而言却是相当不友好,不过不用着急,可以通过一些Zookeeper的开源客户端轻松实现对某一事件的永久监听。</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;get path watch：    注册的监听器能够在监听节点的<span class="code">`内容发生改变`</span>的时候，向客户端发出通知</span><br><span class="line">&gt;stat path watch：   注册的监听器能够在监听节点的<span class="code">`状态发生改变`</span>的时候，向客户端发出通知</span><br><span class="line">&gt;ls/ls2 path watch： 注册的监听器能够在监听节点的<span class="code">`子节点新增和删除`</span>的时候，向客户端发出通知</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意: 下面的操作，需要使用两个客户端来完成，一个负责注册监听，令一个负责修改</span></span><br><span class="line"><span class="comment"># 1) 创建/node/data5</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">23</span>] create /node/<span class="keyword">data</span>5 <span class="keyword">data</span></span><br><span class="line">Created /node/<span class="keyword">data</span>5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 对/node/data5注册get(内容)监听</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">24</span>] get /node/<span class="keyword">data</span>5 watch</span><br><span class="line"><span class="keyword">data</span></span><br><span class="line">cZxid = <span class="number">0</span>x46</span><br><span class="line">ctime = Mon Oct <span class="number">12</span> <span class="number">00</span>:<span class="number">20</span>:<span class="number">37</span> CST <span class="number">2020</span></span><br><span class="line">mZxid = <span class="number">0</span>x46</span><br><span class="line">mtime = Mon Oct <span class="number">12</span> <span class="number">00</span>:<span class="number">20</span>:<span class="number">37</span> CST <span class="number">2020</span></span><br><span class="line">pZxid = <span class="number">0</span>x46</span><br><span class="line">cversion = <span class="number">0</span></span><br><span class="line">dataVersion = <span class="number">0</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">4</span></span><br><span class="line">numChildren = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 此处，新开一个客户端，去修改掉/node/data5的内容: set /node/data5 mydata</span></span><br><span class="line"><span class="comment"># 4) 然后就会发现控制台返回了一个NodeDataChanged(节点数据变化)的通知</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">25</span>]</span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:NodeDataChanged path:/node/<span class="keyword">data</span>5</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) 对/node/data5注册stat(状态)监听</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">25</span>] stat /node/<span class="keyword">data</span>5 watch</span><br><span class="line">cZxid = <span class="number">0</span>x46</span><br><span class="line">ctime = Mon Oct <span class="number">12</span> <span class="number">00</span>:<span class="number">20</span>:<span class="number">37</span> CST <span class="number">2020</span></span><br><span class="line">mZxid = <span class="number">0</span>x49</span><br><span class="line">mtime = Mon Oct <span class="number">12</span> <span class="number">00</span>:<span class="number">21</span>:<span class="number">57</span> CST <span class="number">2020</span></span><br><span class="line">pZxid = <span class="number">0</span>x46</span><br><span class="line">cversion = <span class="number">0</span></span><br><span class="line">dataVersion = <span class="number">2</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">7</span></span><br><span class="line">numChildren = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 此处，新开一个客户端，去修改掉/node/data5的内容: set /node/data5 mydata2</span></span><br><span class="line"><span class="comment"># 3) 然后就会发现控制台返回了一个NodeDataChanged(节点数据变化)的通知</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">26</span>]</span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:NodeDataChanged path:/node/<span class="keyword">data</span>5</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) 对/node/data5注册ls(子节点新增或者删除)监听</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">26</span>] ls /node/<span class="keyword">data</span>5 watch</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) 此处，新开一个客户端，去添加掉/node/data5的子节点: set /node/data5/test test</span></span><br><span class="line"><span class="comment"># 3) 然后就会发现控制台返回了一个NodeChildrenChanged(子节点变化)的通知</span></span><br><span class="line">[<span class="type">zk</span>: <span class="type">localhost</span>:<span class="number">2181</span>(<span class="type">CONNECTED</span>) <span class="number">27</span>]</span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/node/<span class="keyword">data</span>5</span><br></pre></td></tr></table></figure>



<h1 id="Java操作Zookeeper"><a href="#Java操作Zookeeper" class="headerlink" title="Java操作Zookeeper"></a>Java操作Zookeeper</h1><blockquote>
<p>原生API：Java API位于org.apache.ZooKeeper包中。</p>
<p>ZkClient（不推荐）：Github上一个开源的ZooKeeper客户端，在源生 api 基础之上进行扩展的开源 JAVA 客户端。</p>
<p>Apache Curator（推荐使用）：最初是Netfix研发的，后来捐献了Apache基金会，目前是Apache的顶级项目。</p>
</blockquote>
<h2 id="环境导入"><a href="#环境导入" class="headerlink" title="环境导入"></a>环境导入</h2><p><img data-src="/assets/image-20201014104442293.png" alt="image-20201014104442293"> </p>
<h2 id="连接ZK"><a href="#连接ZK" class="headerlink" title="连接ZK"></a>连接ZK</h2><blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;ZK重试策略：</span><br><span class="line">RetryUntilElapsed: 一直重试直到规定的时间，以指定时长的间隔重连,直到超过最大连接时长的时间设置</span><br><span class="line">RetryOneTime:  重连一次</span><br><span class="line">RetryNTimes:  以指定时长的间隔重连，重试重连次数</span><br><span class="line">ExponentialBackoffRetry：衰减重试，随着重试次数的增加，间隔时间也会越来越大。</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接ZK</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CuratorFramework <span class="title">getClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.设置重试策略</span></span><br><span class="line">    RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">//2.创建客户端</span></span><br><span class="line">    CuratorFramework client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2181"</span>, <span class="number">3000</span>, <span class="number">1000</span>, retryPolicy);</span><br><span class="line">    <span class="comment">//3.启动客户端</span></span><br><span class="line">    client.start();</span><br><span class="line">    <span class="comment">//4.返回客户端连接</span></span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建节点</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateNodes</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       String path = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//1. 创建一个空节点a, 值默认为请求端ip</span></span><br><span class="line">       <span class="comment">//path = getClient().create().forPath("/a");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//2. 创建一个有内容的b节点</span></span><br><span class="line">       <span class="comment">//path = getClient().create().forPath("/b", "data".getBytes());</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//3. 创建多层节点</span></span><br><span class="line">       <span class="comment">//creatingParentsIfNeeded() 递归创建父目录</span></span><br><span class="line">       <span class="comment">//withMode() 创建模式</span></span><br><span class="line">       <span class="comment">//path = getClient().create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath("/c/c1/c2", "data".getBytes());</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//4. 创建带有的序号的节点</span></span><br><span class="line">       <span class="comment">//path = getClient().create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT_SEQUENTIAL).forPath("/d");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//5. 创建临时节点（客户端关闭，节点消失），设置延时5秒关闭</span></span><br><span class="line">       <span class="comment">//path = getClient().create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath("/e");</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//6. 创建临时带序号节点（客户端关闭，节点消失），设置延时5秒关闭</span></span><br><span class="line">       <span class="comment">//path = getClient().create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath("/f");</span></span><br><span class="line"></span><br><span class="line">       System.out.println(path);</span><br><span class="line">       <span class="comment">//关闭客户端</span></span><br><span class="line">       getClient().close();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//更新节点</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateNodes</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//更新节点数据</span></span><br><span class="line">       <span class="comment">//getClient().setData().forPath("/a", "itheima".getBytes());</span></span><br><span class="line">       <span class="comment">//根据版本号更新节点数据</span></span><br><span class="line">       <span class="comment">//getClient().setData().withVersion(2).forPath("/a", "itheima".getBytes());</span></span><br><span class="line"></span><br><span class="line">       getClient().close();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//获取节点</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetNodes</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//查询节点数据</span></span><br><span class="line">       <span class="keyword">byte</span>[] bytes = getClient().getData().forPath(<span class="string">"/a"</span>);</span><br><span class="line">       System.out.println(<span class="keyword">new</span> String(bytes));</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 包含状态查询</span></span><br><span class="line">       Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">       getClient().getData().storingStatIn(stat).forPath(<span class="string">"/a"</span>);</span><br><span class="line">       System.out.println(stat.getVersion());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//删除数据</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteNodes</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//删除节点</span></span><br><span class="line">       <span class="comment">//getClient().delete().forPath("/c");</span></span><br><span class="line">       <span class="comment">//删除节点并递归删除其子节点</span></span><br><span class="line">       <span class="comment">//getClient().delete().deletingChildrenIfNeeded().forPath("/c");</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="节点监听"><a href="#节点监听" class="headerlink" title="节点监听"></a>节点监听</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>watch机制</span><br><span class="line"><span class="code">	zookeeperwatch机制，一个轻量级的设计。因为它采用了一种推拉结合的模式。</span></span><br><span class="line">  	一旦服务端感知主题变了，那么只会发送一个事件类型和节点信息给关注的客户端，而不会包括具体的变更内容，所以事件本身是轻量级的，这就是所谓的"推"部分。</span><br><span class="line"><span class="code">	然后，收到变更通知的客户端需要自己去拉变更的数据，这就是"拉"部分。</span></span><br><span class="line"><span class="bullet">* </span>Curator</span><br><span class="line"><span class="code">	watche机制分为添加数据和监听节点。Curator在这方面做了优化，Curator引入了Cache的概念用来实现对ZooKeeper服务器端进行事件监听。</span></span><br><span class="line"><span class="code">	Cache是Curator对事件监听的包装，其对事件的监听可以近似看做是一个本地缓存视图和远程ZooKeeper视图的对比过程。</span></span><br><span class="line"><span class="code">	而且Curator会自动的再次监听，我们就不需要自己手动的重复监听了。</span></span><br><span class="line"><span class="code">	Curator中的cache共有三种:</span></span><br><span class="line"><span class="code">		NodeCache:  用来监听节点的创建和数据变化</span></span><br><span class="line"><span class="code">		PathChildrenCache: 用来监听指定节点的子节点增删和数据变化</span></span><br><span class="line"><span class="code">		TreeCache: 像上面两种Cache的结合体，能够监听自身节点的变化、也能够监听子节点的变化</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.curator.RetryPolicy;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFramework;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.CuratorFrameworkFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.framework.recipes.cache.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.retry.ExponentialBackoffRetry;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Watch机制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WatchDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接ZK</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CuratorFramework <span class="title">getClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.设置重试策略</span></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">//2.创建客户端</span></span><br><span class="line">        CuratorFramework client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2181"</span>, <span class="number">3000</span>, <span class="number">1000</span>, retryPolicy);</span><br><span class="line">        <span class="comment">//3.启动客户端</span></span><br><span class="line">        client.start();</span><br><span class="line">        <span class="comment">//4.返回客户端连接</span></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//只监测当前节点数据</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNodeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建节点数据监听对象</span></span><br><span class="line">        <span class="keyword">final</span> NodeCache nodeCache = <span class="keyword">new</span> NodeCache(getClient(), <span class="string">"/a"</span>);</span><br><span class="line">        nodeCache.start(<span class="keyword">true</span>); <span class="comment">//开始缓存</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(nodeCache.getCurrentData().getData()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加监听对象</span></span><br><span class="line">        nodeCache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">            <span class="comment">//如果节点数据有变化，会回调该方法</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"数据Watcher：路径="</span> + nodeCache.getCurrentData().getPath() + <span class="string">",data="</span> + <span class="keyword">new</span> String(nodeCache.getCurrentData().getData()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//监测所有子节点数据</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPathChildrenCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//监听指定节点的子节点变化情况包括: 新增子节点 子节点数据变更 和子节点删除</span></span><br><span class="line">        PathChildrenCache childrenCache = <span class="keyword">new</span> PathChildrenCache(getClient(), <span class="string">"/a"</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//在启动时缓存子节点数据，提示初始化</span></span><br><span class="line">        childrenCache.start(PathChildrenCache.StartMode.POST_INITIALIZED_EVENT);</span><br><span class="line">        <span class="comment">//添加监听</span></span><br><span class="line">        childrenCache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CHILD_ADDED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"子节点添加："</span> + <span class="keyword">new</span> String(event.getData().getData()));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CHILD_REMOVED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"子节点移除："</span> + <span class="keyword">new</span> String(event.getData().getData()));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CHILD_UPDATED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"子节点修改："</span> + <span class="keyword">new</span> String(event.getData().getData()));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.INITIALIZED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"初始化完成"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CONNECTION_SUSPENDED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"连接过时"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CONNECTION_RECONNECTED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"重新连接"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == PathChildrenCacheEvent.Type.CONNECTION_LOST) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"连接过时一段时间"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监测当前节点和所有的子节点</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTreeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TreeCache treeCache = <span class="keyword">new</span> TreeCache(getClient(), <span class="string">"/a"</span>);</span><br><span class="line">        treeCache.start();</span><br><span class="line"></span><br><span class="line">        System.out.println(treeCache.getCurrentData(<span class="string">"/a"</span>));</span><br><span class="line"></span><br><span class="line">        treeCache.getListenable().addListener(<span class="keyword">new</span> TreeCacheListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.NODE_ADDED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"节点添加"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.NODE_REMOVED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"节点移除"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.NODE_UPDATED) &#123;</span><br><span class="line">                    System.out.println(event.getData().getPath() + <span class="string">"节点修改"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.INITIALIZED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"初始化完成"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.CONNECTION_SUSPENDED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"连接过时"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.CONNECTION_RECONNECTED) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"重新连接"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType() == TreeCacheEvent.Type.CONNECTION_LOST) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"连接过时一段时间"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Zookeeper使用场景"><a href="#Zookeeper使用场景" class="headerlink" title="Zookeeper使用场景"></a>Zookeeper使用场景</h1><h2 id="ID生成器"><a href="#ID生成器" class="headerlink" title="ID生成器"></a>ID生成器</h2><blockquote>
<p>通过在ZooKeepr里创建顺序节点，很容易创建一个全局唯一的名字，即生成全局唯一的ID。</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>在每一台机子上需要id的时候执行一个创建顺序节点的操作,一定可以获取到一个唯一的id</span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>redis  自增长+1</span><br></pre></td></tr></table></figure>

<p><img data-src="/assets/image-20201014113353020.png" alt="image-20201014113353020"> </p>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><blockquote>
<p>配置中心使用的是Zookeeper的watch机制</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>需求： </span><br><span class="line"><span class="code">	在分布式应用系统中，会有很多的类似的配置文件，他们会散落在各个服务中，比如数据库的用户名和密码</span></span><br><span class="line"><span class="code">	如果后期要修改的话，就需要修改非常多的配置文件，这显然不是好的做法，基于这种现状，就有了配置中心的概念</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>方案：</span><br><span class="line"><span class="code">	可以把所有的配置都放在一个配置中心，然后各个服务分别去监听配置中心，一旦发现里面的内容发生变化，立即获取变化的内容，然后更新本地配置即可</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>实现：</span><br><span class="line"><span class="code">	通过Zookeeper的watch机制，我们可以轻松的实现这一需求，</span></span><br><span class="line"><span class="code">	所有的服务需要监听Zookeeper的配置节点，当配置信息发生变化之后，Zookeeper会将变化信息推送给服务，当然服务也可以主动去拉取节点数据</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>说明:</span><br><span class="line"><span class="code">    在这里Zookeeper采用了推拉模式相结合的做法：</span></span><br><span class="line"><span class="code">    	push可以保证能够第一时间拿到更新配置，基本可以做到准实时的更新，但push存在问题，即如果有网络抖动，某一次push没有推送成功，将丢失这次配置的更新</span></span><br><span class="line"><span class="code">    	pull可以保证一定可以拉取得到数据，pull一般采用定时拉取的方式，即使某一次出现网络问题，没有拉取得到数据，那在下一次定时器也将可以拉取得到数据</span></span><br></pre></td></tr></table></figure>

<p> <img data-src="/assets/image-20201014113209852.png" alt="image-20201014113209852"> </p>
<h2 id="分布式协调"><a href="#分布式协调" class="headerlink" title="分布式协调"></a>分布式协调</h2><blockquote>
<p>分布式协调服务使用的是Zookeeper的watch机制</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>不同的客户端如机器节点，发生了变化，那么所有订阅的客户端都能够接收到相应的Watcher通知，并做出相应的处理。</span><br></pre></td></tr></table></figure>

<p><img data-src="/assets/image-20201014144022534.png" alt="image-20201014144022534"> </p>
<h2 id="集群选主"><a href="#集群选主" class="headerlink" title="集群选主"></a>集群选主</h2><blockquote>
<p>集群选主使用的是zookeeper的临时节点</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>需求:</span><br><span class="line"><span class="code">	在集群中，很多情况下是要区分主从节点的，一般情况下主节点负责数据写入，从节点负责数据读取，那么问题来了，怎么确定哪一个节点是主节点的</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="bullet">* </span>实现：</span><br><span class="line"><span class="code">	使用Zookeeper的临时节点可以轻松实现这一需求</span></span><br><span class="line"><span class="code">	我们把上面描述的这个过程称为集群选主的过程，首先所有的节点都认为是从节点，都有机会称为主节点，然后开始选主，步骤比较简单:</span></span><br><span class="line"><span class="bullet">		1. </span>所有参与选主的主机都去Zookeeper上创建同一个临时节点，那么最终一定只有一个客户端请求能够创建成功。</span><br><span class="line"><span class="bullet">		2. </span>成功创建节点的客户端所在的机器就成为了主节点，其他没有成功创建该节点的客户端，成为从节点</span><br><span class="line"><span class="bullet">		3. </span>所有的从节点都会在主节点上注册一个子节点变更的Watcher，用于监控当前主节点是否存活，一旦发现当前的主节点挂了，那么其他客户端将会重新进行选主。</span><br></pre></td></tr></table></figure>

<p> <img data-src="/assets/image-20201014144945595.png" alt="image-20201014144945595"></p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><blockquote>
<p>分布式锁使用的是Zookeeper的临时有序节点</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>需求： </span><br><span class="line"><span class="code">	在分布式系统中，很容出现多台主机操作同一资源的情况， 比如两台主机同时往一个文件中追加写入文本， </span></span><br><span class="line"><span class="code">	如果不去做任何的控制，很有可能出现一个写入操作被另一个写入操作覆盖掉的状况</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>方案：</span><br><span class="line"><span class="code">	此时我们可以来一把锁，哪个主机获取到了这把锁，就执行写入，另一台主机等待;直到写入操作执行完毕，另一台主机再去获得锁，然后写入</span></span><br><span class="line"><span class="code">	这把锁就称为分布式锁， 也就是说:分布式锁是控制分布式系统之间同步访问共享资源的一种方式</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>实现:</span><br><span class="line"><span class="code">	使用Zookeeper的临时有序节点可以轻松实现这一需求</span></span><br><span class="line"><span class="bullet">		1. </span>所有需要执行操作的主机都去Zookeeper上创建一个临时有序节点</span><br><span class="line"><span class="bullet">		2. </span>然后获取到Zookeeper上创建出来的这些节点进行一个从小到大的排序</span><br><span class="line"><span class="bullet">		3. </span>判断自己创建的节点是不是最小的，如果是，自己就获取到了锁;   如果不是，则对最小的节点注册一个监听</span><br><span class="line"><span class="bullet">		4. </span>如果自己获取到了锁，就去执行相应的操作，当执行完毕之后，连接断开，节点消失，锁就被释放了</span><br><span class="line"><span class="bullet">		5. </span>如果自己没有获取到锁，就等待，一直监听节点消失，锁释放后，再重新执行抢夺锁的操作</span><br></pre></td></tr></table></figure>

<p><img data-src="/assets/image-20201014145925480.png" alt="image-20201014145925480"></p>
<h1 id="集群-高级"><a href="#集群-高级" class="headerlink" title="集群(高级)"></a>集群(高级)</h1><h2 id="集群介绍"><a href="#集群介绍" class="headerlink" title="集群介绍"></a>集群介绍</h2><p>Zookeeper在一个系统中一般会充当一个很重要的角色，所以一定要保证它的高可用，这就需要部署Zookeeper的集群。</p>
<p>Zookeeper 有三种运行模式：单机模式、集群模式和伪集群模式。</p>
<ul>
<li>单机模式：使用一台主机部署一个Zookeeper来对外提供服务，有单点故障问题，仅适合于开发、测试环境</li>
<li>集群模式：使用多台服务器，每台上部署一个Zookeeper一起对外提供服务，适合于生产环境</li>
<li>伪集群模式：在服务器不够多的情况下，也可以考虑在一台服务器上部署多个Zookeeper来对外提供服务</li>
</ul>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><blockquote>
<p>本次学习环境，为了方便，我们采用windows平台部署伪集群的方式来演示Zookeeper集群的安装和使用。</p>
</blockquote>
<h3 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h3><p>创建一个文件夹，将Zookeeper软件解压三次，得到三个程序</p>
<p><img data-src="/assets/image-20201012173352810.png" alt="image-20201012173352810"> </p>
<h3 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h3><p>编辑Zookeeper的配置文件，主要修改的是端口号和服务地址[此步骤在所有zk上都有操作]</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>修改的内容</span><br><span class="line"><span class="code">	dataDir： 数据存储的地址，修改为当前zk下的data目录</span></span><br><span class="line"><span class="code">	clientPort：当前zk对外的端口号，因为是在同一个服务器上部署多台，此端口号不能重复</span></span><br><span class="line"><span class="code">	server.id: 集群节点信息</span></span><br><span class="line"><span class="code">		格式为: server.A=B:C:D    </span></span><br><span class="line"><span class="code">        	A：是一个数字，表示这个是服务器的编号    </span></span><br><span class="line"><span class="code">        	B：是这个服务器的ip地址    </span></span><br><span class="line"><span class="code">        	C：Zookeeper服务器之间的通信端口    </span></span><br><span class="line"><span class="code">        	D：Leader选举的端口</span></span><br></pre></td></tr></table></figure>

<h3 id="创建节点ID"><a href="#创建节点ID" class="headerlink" title="创建节点ID"></a>创建节点ID</h3><p>在dataDir 指定的目录下，创建一个文件，名字为：myid，文件内容: 为上一步service.id中的id  [此步骤在所有zk上都有操作]</p>
<h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><p>分别进入到每个zk服务器的bin目录，双击zkServer.cmd，启动三个服务器</p>
<h3 id="连接测试"><a href="#连接测试" class="headerlink" title="连接测试"></a>连接测试</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到其中一个zk的bin目录执行连接命令</span></span><br><span class="line"><span class="comment"># zkCli.cmd -server 连接节点的ip：port</span></span><br><span class="line">zkCli.cmd <span class="literal">-server</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">2182</span></span><br><span class="line">Connecting to <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">2182</span></span><br></pre></td></tr></table></figure>

<h2 id="一致性事务处理"><a href="#一致性事务处理" class="headerlink" title="一致性事务处理"></a>一致性事务处理</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>ZooKeeper集群中的三个角色：</span><br><span class="line"><span class="code">	Leader（领导者）：负责投票的发起和决议，更新系统状态，是事务请求的唯一处理者，一个ZooKeeper同一时刻只会有一个Leader</span></span><br><span class="line"><span class="code">	Follower（跟随者）：处理客户端请求，参与选主投票</span></span><br><span class="line"><span class="code">	Observer（观察者）：处理客户端请求，不参与选主投票</span></span><br><span class="line"><span class="bullet">* </span>Leader可以提供读写服务，Follower或Observer只提供读服务，但是Observer机器不参与Leader选举，也不参与写操作的『过半写成功』策略</span><br></pre></td></tr></table></figure>

<p><img data-src="/assets/image-20201012185750043.png" alt="image-20201012185750043"> </p>
<h3 id="Zookeeper的特性"><a href="#Zookeeper的特性" class="headerlink" title="Zookeeper的特性"></a>Zookeeper的特性</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>顺序性: 从同一个客户端发起的事务请求, 最终会严格按照顺序被应用到zookeeper中</span><br><span class="line"><span class="bullet">2. </span>原子性: 所有的事务请求的处理结果在整个集群中的所有机器上的应用情况是一致的; 也就是说,要么整个集群中的所有机器都成功应用了某一事务、要么全都不应用</span><br><span class="line"><span class="bullet">3. </span>可靠性: 一旦服务器成功应用了某一个事务数据,并且对客户端做了响应,那么这个数据在整个集群中一定是同步并且保留下来的</span><br><span class="line"><span class="bullet">4. </span>实时性: 一旦一个事务被成功应用,客户端就能够立即从服务器端读取到事务变更后的最新数据状态(zookeeper仅仅保证在一定时间内,近实时)</span><br></pre></td></tr></table></figure>

<h3 id="ZAB协议"><a href="#ZAB协议" class="headerlink" title="ZAB协议"></a>ZAB协议</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>Zookeeper采用ZAB(Zookeeper Atomic Broadcast)协议来保证分布式数据一致性。</span><br><span class="line"><span class="bullet">* </span>ZAB并不是一种通用的分布式一致性算法,而是一种专为Zookeeper设计的崩溃可恢复的原子消息广播算法。</span><br><span class="line"><span class="bullet">* </span>ZAB协议包括两种基本模式:崩溃恢复模式和消息广播模式:</span><br><span class="line"><span class="code">	消息广播模式主要用来进行事务请求的处理</span></span><br><span class="line"><span class="code">	崩溃恢复模式主要用来在集群启动过程,或者Leader服务器崩溃退出后进行新的Leader服务器的选举以及数据同步</span></span><br></pre></td></tr></table></figure>

<h3 id="事务请求的处理流程"><a href="#事务请求的处理流程" class="headerlink" title="事务请求的处理流程"></a>事务请求的处理流程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>所有的事务请求都交由集群的Leader服务器来处理,Leader服务器会将一个事务请求转换成一个Proposal(提议),并为其生成一个全局递增的唯一ID,</span><br><span class="line"><span class="code">    这个ID就是事务ID,即ZXID,Leader服务器对Proposal是按其ZXID的先后顺序来进行排序和处理的。</span></span><br><span class="line"><span class="bullet">2. </span>Leader服务器会将Proposal放入每个Follower对应的队列中(Leader会为每个Follower分配一个单独的队列),并以FIFO的方式发送给Follower服务器。</span><br><span class="line"><span class="bullet">3. </span>Follower服务器接收到事务Proposal后,首先以事务日志的方式写入本地磁盘,并且在成功后返回Leader服务器一个ACK响应。</span><br><span class="line"><span class="bullet">4. </span>Leader服务器只要收到过半Follower的ACK响应,就会广播一个Commit消息给Follower以通知其进行Proposal的提交,同时Leader自身也会完成Proposal的提交。</span><br><span class="line"><span class="bullet">5. </span>Follower收到commit请求时，从历史队列中将事务请求commit</span><br></pre></td></tr></table></figure>

<p><img data-src="/assets/image-20201012183855327.png" alt="image-20201012183855327"> </p>
<h2 id="集群选举"><a href="#集群选举" class="headerlink" title="集群选举"></a>集群选举</h2><h3 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>Zookeeper服务器有四个状态</span><br><span class="line"><span class="code">	looking：  寻找leader状态。当服务器处于该状态时，它会认为当前集群中没有leader，因此需要进入leader选举状态。</span></span><br><span class="line"><span class="code">	leading：  领导者状态。表明当前服务器角色是leader。</span></span><br><span class="line"><span class="code">	following：跟随者状态。表明当前服务器角色是follower。</span></span><br><span class="line"><span class="code">	observing：观察者状态。表明当前服务器角色是observer。</span></span><br></pre></td></tr></table></figure>

<h3 id="服务器启动时期的leader选举"><a href="#服务器启动时期的leader选举" class="headerlink" title="服务器启动时期的leader选举"></a>服务器启动时期的leader选举</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>在集群初始化阶段，当有一台服务器server1启动时，其单独无法进行和完成leader选举，</span><br><span class="line"><span class="bullet">* </span>当第二台服务器server2启动时，此时两台机器可以相互通信，每台机器都试图找到leader，于是进入leader选举过程。 </span><br><span class="line"><span class="bullet">* </span>选举过程如下:</span><br><span class="line"><span class="bullet">	1. </span>每个server发出一个投票。</span><br><span class="line"><span class="code">	   由于是初始情况，server1和server2都会将自己作为leader服务器来进行投票，每次投票会包含所推举的服务器的myid和zxid，</span></span><br><span class="line"><span class="code">	   使用(myid, zxid)来表示，此时server1的投票为(1, 0)，server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。</span></span><br><span class="line"><span class="bullet">	2. </span>集群中的每台服务器接收来自集群中各个服务器的投票。</span><br><span class="line"><span class="bullet">	3. </span>处理投票。针对每一个投票，服务器都需要将别人的投票和自己的投票进行pk，pk规则如下:</span><br><span class="line"><span class="code">		优先检查zxid。zxid比较大的服务器优先作为leader。</span></span><br><span class="line"><span class="code">		如果zxid相同，那么就比较myid。myid较大的服务器作为leader服务器。</span></span><br><span class="line"> 		对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的zxid，均为0，再比较myid，此时server2的myid最大，</span><br><span class="line"> 		于是更新自己的投票为(2, 0)，然后重新投票，对于server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。</span><br><span class="line"><span class="bullet">	4. </span>统计投票。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，</span><br><span class="line"><span class="code">		对于server1、server2而言，都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了leader</span></span><br><span class="line"><span class="bullet">	5. </span>改变服务器状态。一旦确定了leader，每个服务器就会更新自己的状态，如果是follower，那么就变更为following，如果是leader，就变更为leading。</span><br></pre></td></tr></table></figure>

<h3 id="服务器运行时期的Leader选举"><a href="#服务器运行时期的Leader选举" class="headerlink" title="服务器运行时期的Leader选举"></a>服务器运行时期的Leader选举</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>在zookeeper运行期间，leader与非leader服务器各司其职，即便当有非leader服务器宕机或新加入，此时也不会影响leader，</span><br><span class="line"><span class="bullet">* </span>但是一旦leader服务器挂了，那么整个集群将暂停对外服务，进入新一轮leader选举，其过程和启动时期的Leader选举过程基本一致。</span><br><span class="line"><span class="bullet">* </span>假设正在运行的有server1、server2、server3三台服务器，当前leader是server2，若某一时刻leader挂了，此时便开始Leader选举。</span><br><span class="line"><span class="bullet">* </span>选举过程如下:</span><br><span class="line"><span class="bullet">	1. </span>变更状态。leader挂后，余下的服务器都会将自己的服务器状态变更为looking，然后开始进入leader选举过程。</span><br><span class="line"><span class="bullet">	2. </span>每个server会发出一个投票。</span><br><span class="line"><span class="code">		在运行期间，每个服务器上的zxid可能不同，此时假定server1的zxid为122，server3的zxid为122，</span></span><br><span class="line"><span class="code">		在第一轮投票中，server1和server3都会投自己，产生投票(1, 122)，(3, 122)，然后各自将投票发送给集群中所有机器。</span></span><br><span class="line"><span class="bullet">	3. </span>接收来自各个服务器的投票。与启动时过程相同</span><br><span class="line"><span class="bullet">	4. </span>处理投票。与启动时过程相同，此时，server3将会成为leader。</span><br><span class="line"><span class="bullet">	5. </span>统计投票。与启动时过程相同。</span><br><span class="line"><span class="bullet">	6. </span>改变服务器的状态。与启动时过程相同。</span><br></pre></td></tr></table></figure>

<h3 id="observer角色及其配置"><a href="#observer角色及其配置" class="headerlink" title="observer角色及其配置"></a>observer角色及其配置</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>observer角色特点：</span><br><span class="line"><span class="bullet">	1. </span>不参与集群的leader选举</span><br><span class="line"><span class="bullet">	2. </span>不参与集群中写数据时的ack反馈</span><br><span class="line"><span class="bullet">* </span>为了使用observer角色，在任何想变成observer角色的配置文件中加入如下配置：</span><br><span class="line"><span class="code">	peerType=observer</span></span><br><span class="line"><span class="bullet">* </span>并在所有server的配置文件中，配置成observer模式的server的那行配置追加:observer</span><br><span class="line"><span class="code">	server.3=192.168.60.130:2289:3389:observer</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    
    
    <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束 <i class="fa fa-heart"></i> 感谢阅读-------------</div>

    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%B0%83%E6%A1%86%E6%9E%B6/" rel="tag"><i class="fa fa-tag"></i> 分布式协调框架</a>
              <a href="/tags/zookeeper%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag"><i class="fa fa-tag"></i> zookeeper数据结构</a>
              <a href="/tags/zookeeper%E5%B8%B8%E8%A7%81%E5%91%BD%E4%BB%A4/" rel="tag"><i class="fa fa-tag"></i> zookeeper常见命令</a>
              <a href="/tags/zookeeper%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" rel="tag"><i class="fa fa-tag"></i> zookeeper使用场景</a>
              <a href="/tags/zookeeper%E9%9B%86%E7%BE%A4/" rel="tag"><i class="fa fa-tag"></i> zookeeper集群</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/13/Dubbo/" rel="prev" title="Dubbo">
      <i class="fa fa-chevron-left"></i> Dubbo
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/10/16/Mybatis%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B-%E4%B8%83%E7%89%9B%E4%BA%91%E5%AD%98%E5%82%A8/" rel="next" title="Mybatis逆向工程&七牛云存储">
      Mybatis逆向工程&七牛云存储 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



        </div>
        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sunmoon</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">850k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">12:53</span>
</div>



        








      </div>
    </footer>
  </div>

  
  <script defer src="//cdn.jsdelivr.net/gh/next-theme/theme-next-three@1/three.min.js"></script>
    <script defer src="//cdn.jsdelivr.net/gh/next-theme/theme-next-three@1/canvas_lines.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  


  <!-- 樱花特效 -->
  
      <script async src="/js/src/fairyDustCursor.js"></script>
  


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
    <!-- 页面点击小红心 -->
    <script type="text/javascript" src="/js/src/love.js"></script>



